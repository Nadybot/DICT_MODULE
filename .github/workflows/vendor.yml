name: Create release bundle
on:
  release:
    types: [published]

jobs:
  build:
    name: Create vendor bundle
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
      - name: Setup PHP 8.1 with composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer:v2
      - name: Install dependencies
        shell: bash
        run: |
          composer install --no-dev --no-suggest
          composer dumpautoload --no-dev --optimize
      - name: Create directory zip
        shell: bash
        run: |
          cd ..
          zip -r dict-bundle-${{ github.event.release.tag_name }}.zip DICT_MODULE/ -x "*.git*"
          mv dict-bundle-${{ github.event.release.tag_name }}.zip DICT_MODULE/
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./dict-bundle-${{ github.event.release.tag_name }}.zip
          asset_name: dict-bundle-${{ github.event.release.tag_name }}.zip
          asset_content_type: application/zip
      - name: Notify aopkg
        uses: distributhor/workflow-webhook@v1
        env:
          webhook_type: 'json-extended'
          webhook_url: 'https://pkg.aobots.org/webhook'
          webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
